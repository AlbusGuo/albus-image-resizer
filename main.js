/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var S=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var H=(_,e)=>{for(var n in e)S(_,n,{get:e[n],enumerable:!0})},P=(_,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of A(e))!W.call(_,s)&&s!==n&&S(_,s,{get:()=>e[s],enumerable:!(t=T(e,s))||t.enumerable});return _};var U=_=>P(S({},"__esModule",{value:!0}),_);var V={};H(V,{default:()=>z});module.exports=U(V);var R=require("obsidian");var L={resizeInterval:0,edgeSize:20,dragResize:!0,debug:!1};var k=require("obsidian");var E=class extends k.PluginSettingTab{constructor(n,t){super(n,t);this.plugin=t}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"\u56FE\u7247\u8C03\u6574\u5927\u5C0F\u8BBE\u7F6E"}),new k.Setting(n).setName("\u542F\u7528\u62D6\u62FD\u8C03\u6574\u5927\u5C0F").setDesc("\u662F\u5426\u5141\u8BB8\u901A\u8FC7\u62D6\u62FD\u56FE\u7247\u8FB9\u7F18\u6765\u8C03\u6574\u56FE\u7247\u5927\u5C0F").addToggle(t=>t.setValue(this.plugin.settings.dragResize).onChange(async s=>{this.plugin.settings.dragResize=s,await this.plugin.saveSettings()})),new k.Setting(n).setName("\u8C03\u6574\u5927\u5C0F\u7684\u65F6\u95F4\u95F4\u9694").setDesc("\u62D6\u52A8\u8C03\u6574\u6700\u5C0F\u523B\u5EA6\uFF08\u9ED8\u8BA4\u503C\u4E3A 0 \u5373\u4E0D\u5BF9\u9F50\u523B\u5EA6\uFF09").addText(t=>t.setPlaceholder("0").setValue(this.plugin.settings.resizeInterval.toString()).onChange(async s=>{s===""?(this.plugin.settings.resizeInterval=0,await this.plugin.saveSettings()):/^\d+$/.test(s)&&Number(s)>=0?(this.plugin.settings.resizeInterval=parseInt(s),await this.plugin.saveSettings()):(new k.Notice("\u8BF7\u8F93\u5165\u975E\u8D1F\u6574\u6570"),t.setValue(this.plugin.settings.resizeInterval.toString()))})),new k.Setting(n).setName("\u8FB9\u7F18\u68C0\u6D4B\u533A\u57DF\u5927\u5C0F").setDesc("\u9F20\u6807\u5728\u56FE\u7247\u8FB9\u7F18\u591A\u5C11\u50CF\u7D20\u5185\u53EF\u4EE5\u89E6\u53D1\u8C03\u6574\u5927\u5C0F\uFF08\u5355\u4F4D\uFF1A\u50CF\u7D20\uFF09").addSlider(t=>t.setLimits(5,150,1).setValue(this.plugin.settings.edgeSize).setDynamicTooltip().onChange(async s=>{this.plugin.settings.edgeSize=s,await this.plugin.saveSettings()})),new k.Setting(n).setName("\u8C03\u8BD5\u6A21\u5F0F").setDesc("\u542F\u7528\u8C03\u8BD5\u6A21\u5F0F\u4EE5\u5728\u63A7\u5236\u53F0\u8F93\u51FA\u8BE6\u7EC6\u65E5\u5FD7\u4FE1\u606F").addToggle(t=>t.setValue(this.plugin.settings.debug).onChange(async s=>{this.plugin.settings.debug=s,await this.plugin.saveSettings()})),n.createEl("hr"),new k.Setting(n).setName("\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u8BBE\u7F6E").setDesc("\u5C06\u6240\u6709\u8BBE\u7F6E\u6062\u590D\u4E3A\u9ED8\u8BA4\u503C").addButton(t=>t.setButtonText("\u91CD\u7F6E").setWarning().onClick(async()=>{this.plugin.settings={...L},await this.plugin.saveSettings(),this.display(),new k.Notice("\u8BBE\u7F6E\u5DF2\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u503C")}))}};var $=require("obsidian");var x=require("obsidian"),M=class{constructor(e){this.plugin=e}updateImageLinkWithNewSize(e,n,t,s){var o;let i=this.plugin.app.workspace.getActiveViewOfType(x.MarkdownView);if(!i)return;let c=e.closest("table")!=null,h=e.closest(".callout")!=null,u=e.classList.contains("excalidraw-embedded-img"),a=e.getAttribute("src");if(this.plugin.settings.debug&&(console.log("[Image Debug] ========== \u5F00\u59CB\u8C03\u6574\u56FE\u7247\u5927\u5C0F =========="),console.log("[Image Debug] img.src:",e.getAttribute("src")),console.log("[Image Debug] inTable:",c),console.log("[Image Debug] inCallout:",h),console.log("[Image Debug] isExcalidraw:",u)),a!=null&&a.startsWith("http"))this.plugin.settings.debug&&console.log("[Image Debug] \u68C0\u6D4B\u5230\u5916\u90E8\u94FE\u63A5"),this.updateExternalLink(i,e,n,t,s,c,h);else if(u){let r=this.getExcalidrawBaseName(e);e.style.maxWidth="none",this.plugin.settings.debug&&console.log("[Image Debug] \u68C0\u6D4B\u5230 Excalidraw\uFF0Cbasename:",r),this.updateInternalLink(i,e,n,r,t,s,c,h)}else a=((o=e.closest(".internal-embed"))==null?void 0:o.getAttribute("src"))||null,this.plugin.settings.debug&&(console.log("[Image Debug] \u68C0\u6D4B\u5230\u5185\u90E8\u56FE\u7247"),console.log("[Image Debug] .internal-embed src:",a),console.log("[Image Debug] \u6700\u7EC8 imageName:",a)),this.updateInternalLink(i,e,n,a,t,s,c,h)}updateInternalLink(e,n,t,s,i,c,h,u){if(!s)return;let a=e.editor,o=a.cm,r=o.state.doc.lineAt(t);if(this.plugin.settings.debug&&(console.log("[Image Debug] updateInternalLink called"),console.log("[Image Debug] imageName:",s),console.log("[Image Debug] target_line:",r.text),console.log("[Image Debug] inTable:",h,"inCallout:",u)),!u&&!h){let g=this.matchLineWithInternalLink(r.text,s,i,h);g.length===1?o.dispatch({changes:{from:r.from+g[0].from_ch,to:r.from+g[0].to_ch,insert:g[0].new_link}}):g.length===0||new x.Notice("\u5728\u5F53\u524D\u884C\u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!");return}let f={table:/^\s*\|/,callout:/^>/},m=h?"table":"callout",b=f[m],w=r.number,p=[],v=[];this.plugin.settings.debug&&console.log(`[${m} Debug] \u5F00\u59CB\u641C\u7D22\uFF0C\u8D77\u59CB\u884C:`,w);for(let g=w;g<=a.lineCount();g++){let l=o.state.doc.line(g);if(!b.test(l.text))break;let d=this.matchLineWithInternalLink(l.text,s,i,h);this.plugin.settings.debug&&d.length>0&&console.log(`[${m} Debug] \u7B2C${g}\u884C\u5339\u914D:`,d),p.push(...d),v.push(...new Array(d.length).fill(g))}for(let g=w-1;g>=1;g--){let l=o.state.doc.line(g);if(!b.test(l.text))break;let d=this.matchLineWithInternalLink(l.text,s,i,h);this.plugin.settings.debug&&d.length>0&&console.log(`[${m} Debug] \u7B2C${g}\u884C\u5339\u914D:`,d),p.push(...d),v.push(...new Array(d.length).fill(g))}if(this.plugin.settings.debug&&console.log(`[${m} Debug] \u603B\u5339\u914D\u7ED3\u679C:`,p.length),p.length===1){let g=o.state.doc.line(v[0]);if(m==="table"){let l=g.text,d=l.substring(0,p[0].from_ch)+p[0].new_link+l.substring(p[0].to_ch);o.dispatch({changes:{from:g.from,to:g.from+l.length,insert:d}})}else o.dispatch({changes:{from:g.from+p[0].from_ch,to:g.from+p[0].to_ch,insert:p[0].new_link}})}else p.length===0?new x.Notice(`\u5728 ${m==="table"?"\u8868\u683C":"callout"} \u4E2D\u672A\u80FD\u627E\u5230\u5F53\u524D\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`):new x.Notice(`\u5728 ${m==="table"?"\u8868\u683C":"callout"} \u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`)}updateExternalLink(e,n,t,s,i,c,h){let u=e.editor,a=u.cm,o=a.state.doc.lineAt(t),r=n.getAttribute("src"),f=n.getAttribute("alt");if(!r)return;if(!h&&!c){let l=this.matchLineWithExternalLink(o.text,r,f||"",s,c);l.length===1?a.dispatch({changes:{from:o.from+l[0].from_ch,to:o.from+l[0].to_ch,insert:l[0].new_link}}):l.length===0||new x.Notice("\u5728\u5F53\u524D\u884C\u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!");return}let m={table:/^\s*\|/,callout:/^>/},b=c?"table":"callout",w=m[b],p=o.number,v=[],g=[];for(let l=p;l<=u.lineCount();l++){let d=a.state.doc.line(l);if(!w.test(d.text))break;let I=this.matchLineWithExternalLink(d.text,r,f||"",s,c);v.push(...I),g.push(...new Array(I.length).fill(l))}for(let l=p-1;l>=1;l--){let d=a.state.doc.line(l);if(!w.test(d.text))break;let I=this.matchLineWithExternalLink(d.text,r,f||"",s,c);v.push(...I),g.push(...new Array(I.length).fill(l))}if(v.length===1){let l=a.state.doc.line(g[0]);if(b==="table"){let d=l.text,I=d.substring(0,v[0].from_ch)+v[0].new_link+d.substring(v[0].to_ch);a.dispatch({changes:{from:l.from,to:l.from+d.length,insert:I}})}else a.dispatch({changes:{from:l.from+v[0].from_ch,to:l.from+v[0].to_ch,insert:v[0].new_link}})}else v.length===0?new x.Notice(`\u5728 ${b==="table"?"\u8868\u683C":"callout"} \u4E2D\u672A\u80FD\u627E\u5230\u5F53\u524D\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`):new x.Notice(`\u5728 ${b==="table"?"\u8868\u683C":"callout"} \u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`)}matchLineWithInternalLink(e,n,t,s){let i=/\!\[\[[^\[\]]*?\]\]/g,c=/\!\[[^\[\]]*?\]\(\s*[^\[\]\{\}']*\s*\)/g,h=n.replace(/ /g,"%20");if(!e.includes(n)&&!e.includes(h))return[];let u=[],a;for(;(a=i.exec(e))!==null;){let r=a[0];if(r.includes(n)){let m=(s?r.replace(/\\\|/g,"|"):r).match(/!\[\[(.*?)(\||\]\])/),b=m?m[1]:"",w=r.match(/!\[\[.*?(\|(.*?))\]\]/),v=(w?w[1]:"").split("|"),g="";for(let y of v)!/^\d+$/.test(y)&&!/^\s*$/.test(y)&&(g=g+"|"+y);let l=t!==0?`${g}|${t}`:g,d=s?l.replace(/\|/g,"\\|"):l,I=m?`![[${b}${d}]]`:`![[${n}${d}]]`;u.push({old_link:r,new_link:I,from_ch:a.index,to_ch:a.index+r.length})}}let o;for(;(o=c.exec(e))!==null;){let r=o[0];if(r.includes(h)){let f=r.match(/\[.*?\]/g);if(!f)continue;let m=f[0].substring(1,f[0].length-1),b=m.replace(/\|\d+(\|\d+)?$/g,"");s&&(b=m.replace(/\\\|\d+(\|\d+)?$/g,""));let w=r.substring(f[0].length+2,r.length-1),p=s?`![${b}\\|${t}](${w})`:`![${b}|${t}](${w})`;/^\d*$/.test(m)?u.push({old_link:r,new_link:`![${t}](${w})`,from_ch:o.index,to_ch:o.index+r.length}):u.push({old_link:r,new_link:p,from_ch:o.index,to_ch:o.index+r.length})}}return u}matchLineWithExternalLink(e,n,t,s,i){let c=[],h=/\!\[[^\[\]]*?\]\(\s*[^\[\]\{\}']*\s*\)/g;if(!e.includes(n))return[];let u;for(;(u=h.exec(e))!==null;){let a=u[0];if(a.includes(n)){let o=a.match(/\[.*?\]/g);if(!o)continue;let r=o[0].substring(1,o[0].length-1),f=r.replace(/\|\d+(\|\d+)?$/g,"");i&&(f=r.replace(/\\\|\d+(\|\d+)?$/g,"")),/^\d*$/.test(r)&&(f="");let m=a.substring(o[0].length+2,a.length-1),b=i?`![${f}\\|${s}](${m})`:`![${f}|${s}](${m})`;c.push({old_link:a,new_link:b,from_ch:u.index,to_ch:u.index+a.length})}}return c}getExcalidrawBaseName(e){let t=e.getAttribute("filesource")||"";if(t.includes("/")){let s=t.split("/");t=s[s.length-1]}else if(t.includes("\\")){let s=t.split("\\");t=s[s.length-1]}return t=t.endsWith(".md")?t.substring(0,t.length-3):t,t}};var D=class{constructor(e){this.isDragging=!1;this.dragTarget=null;this.startX=0;this.startY=0;this.startWidth=0;this.startHeight=0;this.lastUpdateX=0;this.lastUpdate=1;this.updatedWidth=0;this.lastMoveTime=0;this.plugin=e,this.linkUpdateService=new M(e)}registerDocument(e){let n=i=>{i.target.tagName==="IMG"&&this.handleMouseDown(i)};e.addEventListener("mousedown",n),this.plugin.register(()=>e.removeEventListener("mousedown",n));let t=i=>{i.target.tagName==="IMG"&&this.handleMouseMove(i)};e.addEventListener("mousemove",t),this.plugin.register(()=>e.removeEventListener("mousemove",t));let s=i=>{i.target.tagName==="IMG"&&this.handleMouseLeave(i)};e.addEventListener("mouseleave",s),this.plugin.register(()=>e.removeEventListener("mouseleave",s))}handleMouseDown(e){let n=this.plugin.app.workspace.getActiveFile();if(!n||n.name.endsWith(".canvas"))return;let t=this.plugin.app.workspace.getActiveViewOfType($.MarkdownView);if(!t||t.getMode()==="preview")return;e.button===0&&e.preventDefault();let s=e.target,i=t.editor;if(!i)return;let c=s.getBoundingClientRect(),h=e.clientX-c.left,u=e.clientY-c.top,a=this.plugin.settings.edgeSize;h>c.width-a&&u>c.height-a&&this.startDrag(e,s,i)}handleMouseMove(e){let n=this.plugin.app.workspace.getActiveFile();if(!n||n.name.endsWith(".canvas"))return;let t=this.plugin.app.workspace.getActiveViewOfType($.MarkdownView);if(!t||t.getMode()==="preview")return;let s=e.target,i=s.getBoundingClientRect(),c=e.clientX-i.left,h=e.clientY-i.top,u=this.plugin.settings.edgeSize;c>i.width-u&&h>i.height-u?s.style.cursor="nwse-resize":s.style.cursor=""}handleMouseLeave(e){let n=e.target;n.style.cursor=""}startDrag(e,n,t){this.isDragging=!0,this.dragTarget=n,this.startX=e.clientX,this.startY=e.clientY,this.startWidth=n.clientWidth,this.startHeight=n.clientHeight,this.lastUpdateX=this.startX,this.lastUpdate=1,this.updatedWidth=this.startWidth,this.lastMoveTime=Date.now();let i=t.cm.posAtDOM(n),c=o=>{o.preventDefault(),o.stopPropagation()},h=o=>{n.addEventListener("click",c),this.performDrag(o,n,i)},u=()=>{n.removeEventListener("click",c)},a=o=>{setTimeout(u,100),o.preventDefault(),document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",a),this.endDrag(n,i)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",a)}performDrag(e,n,t){let s=e.clientX;this.lastUpdate=s-this.lastUpdateX===0?this.lastUpdate:s-this.lastUpdateX;let i=this.startWidth+(s-this.startX),c=this.startWidth/this.startHeight;i=Math.max(i,50);let h=i/c;i=Math.round(i),h=Math.round(h),this.updatedWidth=i,n.style.width=`${i}px`;let u=Date.now();u-this.lastMoveTime<100||(this.lastMoveTime=u,this.linkUpdateService.updateImageLinkWithNewSize(n,t,i,h),this.lastUpdateX=e.clientX)}endDrag(e,n){if(e.style.removeProperty("width"),e.style.removeProperty("height"),e.style.removeProperty("max-width"),e.style.removeProperty("max-height"),this.plugin.settings.resizeInterval>1){let t=this.plugin.settings.resizeInterval,s=this.lastUpdate>0?t:0;this.updatedWidth%t!==0&&(this.updatedWidth=Math.floor(this.updatedWidth/t)*t+s),this.linkUpdateService.updateImageLinkWithNewSize(e,n,this.updatedWidth,0)}this.isDragging=!1,this.dragTarget=null}};var z=class extends R.Plugin{async onload(){console.log("Image Resize Plugin \u63D2\u4EF6\u5DF2\u52A0\u8F7D..."),await this.loadSettings(),this.resizeHandler=new D(this),this.addSettingTab(new E(this.app,this)),this.registerDocument(document),this.app.workspace.on("window-open",(n,t)=>{this.registerDocument(t.document)}),this.settings.debug&&(console.log("Image Resize Plugin \u8C03\u8BD5\u6A21\u5F0F\u5DF2\u542F\u7528"),console.log("\u5F53\u524D\u8BBE\u7F6E:",this.settings))}onunload(){console.log("Image Resize Plugin \u63D2\u4EF6\u5DF2\u5378\u8F7D...")}registerDocument(n){this.settings.dragResize&&this.resizeHandler.registerDocument(n)}async loadSettings(){this.settings=Object.assign({},L,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.settings.debug&&console.log("\u8BBE\u7F6E\u5DF2\u4FDD\u5B58:",this.settings)}};
