/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var D=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var H=(k,t)=>{for(var s in t)D(k,s,{get:t[s],enumerable:!0})},P=(k,t,s,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of A(t))!W.call(k,n)&&n!==s&&D(k,n,{get:()=>t[n],enumerable:!(e=$(t,n))||e.enumerable});return k};var U=k=>P(D({},"__esModule",{value:!0}),k);var V={};H(V,{default:()=>y});module.exports=U(V);var T=require("obsidian");var I={resizeInterval:0,edgeSize:20,dragResize:!0,debug:!1};var x=require("obsidian");var b=class extends x.PluginSettingTab{constructor(s,e){super(s,e);this.plugin=e}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"\u56FE\u7247\u8C03\u6574\u5927\u5C0F\u8BBE\u7F6E"}),new x.Setting(s).setName("\u542F\u7528\u62D6\u62FD\u8C03\u6574\u5927\u5C0F").setDesc("\u662F\u5426\u5141\u8BB8\u901A\u8FC7\u62D6\u62FD\u56FE\u7247\u8FB9\u7F18\u6765\u8C03\u6574\u56FE\u7247\u5927\u5C0F").addToggle(e=>e.setValue(this.plugin.settings.dragResize).onChange(async n=>{this.plugin.settings.dragResize=n,await this.plugin.saveSettings()})),new x.Setting(s).setName("\u8C03\u6574\u5927\u5C0F\u7684\u65F6\u95F4\u95F4\u9694").setDesc("\u62D6\u52A8\u8C03\u6574\u6700\u5C0F\u523B\u5EA6\uFF08\u9ED8\u8BA4\u503C\u4E3A 0 \u5373\u4E0D\u5BF9\u9F50\u523B\u5EA6\uFF09").addText(e=>e.setPlaceholder("0").setValue(this.plugin.settings.resizeInterval.toString()).onChange(async n=>{n===""?(this.plugin.settings.resizeInterval=0,await this.plugin.saveSettings()):/^\d+$/.test(n)&&Number(n)>=0?(this.plugin.settings.resizeInterval=parseInt(n),await this.plugin.saveSettings()):(new x.Notice("\u8BF7\u8F93\u5165\u975E\u8D1F\u6574\u6570"),e.setValue(this.plugin.settings.resizeInterval.toString()))})),new x.Setting(s).setName("\u8FB9\u7F18\u68C0\u6D4B\u533A\u57DF\u5927\u5C0F").setDesc("\u9F20\u6807\u5728\u56FE\u7247\u8FB9\u7F18\u591A\u5C11\u50CF\u7D20\u5185\u53EF\u4EE5\u89E6\u53D1\u8C03\u6574\u5927\u5C0F\uFF08\u5355\u4F4D\uFF1A\u50CF\u7D20\uFF09").addSlider(e=>e.setLimits(5,150,1).setValue(this.plugin.settings.edgeSize).setDynamicTooltip().onChange(async n=>{this.plugin.settings.edgeSize=n,await this.plugin.saveSettings()})),new x.Setting(s).setName("\u8C03\u8BD5\u6A21\u5F0F").setDesc("\u542F\u7528\u8C03\u8BD5\u6A21\u5F0F\u4EE5\u5728\u63A7\u5236\u53F0\u8F93\u51FA\u8BE6\u7EC6\u65E5\u5FD7\u4FE1\u606F").addToggle(e=>e.setValue(this.plugin.settings.debug).onChange(async n=>{this.plugin.settings.debug=n,await this.plugin.saveSettings()})),s.createEl("hr"),new x.Setting(s).setName("\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u8BBE\u7F6E").setDesc("\u5C06\u6240\u6709\u8BBE\u7F6E\u6062\u590D\u4E3A\u9ED8\u8BA4\u503C").addButton(e=>e.setButtonText("\u91CD\u7F6E").setWarning().onClick(async()=>{this.plugin.settings={...I},await this.plugin.saveSettings(),this.display(),new x.Notice("\u8BBE\u7F6E\u5DF2\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u503C")}))}};var R=require("obsidian");var M=require("obsidian"),E=class{constructor(t){this.plugin=t}updateImageLinkWithNewSize(t,s,e,n){var r;let i=this.plugin.app.workspace.getActiveViewOfType(M.MarkdownView);if(!i)return;let c=t.closest("table")!=null,h=t.closest(".callout")!=null,u=t.classList.contains("excalidraw-embedded-img"),a=t.getAttribute("src");if(a!=null&&a.startsWith("http"))this.updateExternalLink(i,t,s,e,n,c,h);else if(u){let l=this.getExcalidrawBaseName(t);t.style.maxWidth="none",this.updateInternalLink(i,t,s,l,e,n,c,h)}else a=((r=t.closest(".internal-embed"))==null?void 0:r.getAttribute("src"))||null,this.updateInternalLink(i,t,s,a,e,n,c,h)}updateInternalLink(t,s,e,n,i,c,h,u){if(!n)return;let a=t.editor,r=a.cm,l=r.state.doc.lineAt(e);if(!u&&!h){let g=this.matchLineWithInternalLink(l.text,n,i,h);g.length===1?r.dispatch({changes:{from:l.from+g[0].from_ch,to:l.from+g[0].to_ch,insert:g[0].new_link}}):g.length===0||new M.Notice("\u5728\u5F53\u524D\u884C\u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!");return}let p={table:/^\s*\|/,callout:/^>/},m=h?"table":"callout",w=p[m],_=l.number,f=[],v=[];for(let g=_;g<=a.lineCount;g++){let o=r.state.doc.line(g);if(!w.test(o.text))break;let d=this.matchLineWithInternalLink(o.text,n,i,h);f.push(...d),v.push(...new Array(d.length).fill(g))}for(let g=_-1;g>=1;g--){let o=r.state.doc.line(g);if(!w.test(o.text))break;let d=this.matchLineWithInternalLink(o.text,n,i,h);f.push(...d),v.push(...new Array(d.length).fill(g))}if(f.length===1){let g=r.state.doc.line(v[0]);if(m==="table"){let o=g.text,d=o.substring(0,f[0].from_ch)+f[0].new_link+o.substring(f[0].to_ch);r.dispatch({changes:{from:g.from,to:g.from+o.length,insert:d}})}else r.dispatch({changes:{from:g.from+f[0].from_ch,to:g.from+f[0].to_ch,insert:f[0].new_link}})}else f.length===0?new M.Notice(`\u5728 ${m==="table"?"\u8868\u683C":"callout"} \u4E2D\u672A\u80FD\u627E\u5230\u5F53\u524D\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`):new M.Notice(`\u5728 ${m==="table"?"\u8868\u683C":"callout"} \u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`)}updateExternalLink(t,s,e,n,i,c,h){let u=t.editor,a=u.cm,r=a.state.doc.lineAt(e),l=s.getAttribute("src"),p=s.getAttribute("alt");if(!l)return;if(!h&&!c){let o=this.matchLineWithExternalLink(r.text,l,p||"",n,c);o.length===1?a.dispatch({changes:{from:r.from+o[0].from_ch,to:r.from+o[0].to_ch,insert:o[0].new_link}}):o.length===0||new M.Notice("\u5728\u5F53\u524D\u884C\u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!");return}let m={table:/^\s*\|/,callout:/^>/},w=c?"table":"callout",_=m[w],f=r.number,v=[],g=[];for(let o=f;o<=u.lineCount;o++){let d=a.state.doc.line(o);if(!_.test(d.text))break;let L=this.matchLineWithExternalLink(d.text,l,p||"",n,c);v.push(...L),g.push(...new Array(L.length).fill(o))}for(let o=f-1;o>=1;o--){let d=a.state.doc.line(o);if(!_.test(d.text))break;let L=this.matchLineWithExternalLink(d.text,l,p||"",n,c);v.push(...L),g.push(...new Array(L.length).fill(o))}if(v.length===1){let o=a.state.doc.line(g[0]);if(w==="table"){let d=o.text,L=d.substring(0,v[0].from_ch)+v[0].new_link+d.substring(v[0].to_ch);a.dispatch({changes:{from:o.from,to:o.from+d.length,insert:L}})}else a.dispatch({changes:{from:o.from+v[0].from_ch,to:o.from+v[0].to_ch,insert:v[0].new_link}})}else v.length===0?new M.Notice(`\u5728 ${w==="table"?"\u8868\u683C":"callout"} \u4E2D\u672A\u80FD\u627E\u5230\u5F53\u524D\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`):new M.Notice(`\u5728 ${w==="table"?"\u8868\u683C":"callout"} \u4E2D\u627E\u5230\u591A\u4E2A\u76F8\u540C\u7684\u56FE\u50CF\u94FE\u63A5,\u8BF7\u624B\u52A8\u7F29\u653E!`)}matchLineWithInternalLink(t,s,e,n){let i=/\!\[\[[^\[\]]*?\]\]/g,c=/\!\[[^\[\]]*?\]\(\s*[^\[\]\{\}']*\s*\)/g,h=s.replace(/ /g,"%20");if(!t.includes(s)&&!t.includes(h))return[];let u=[],a;for(;(a=i.exec(t))!==null;){let l=a[0];if(l.includes(s)){let m=(n?l.replace(/\\\|/g,"|"):l).match(/!\[\[(.*?)(\||\]\])/),w=m?m[1]:"",_=l.match(/!\[\[.*?(\|(.*?))\]\]/),v=(_?_[1]:"").split("|"),g="";for(let S of v)!/^\d+$/.test(S)&&!/^\s*$/.test(S)&&(g=g+"|"+S);let o=e!==0?`${g}|${e}`:g,d=n?o.replace(/\|/g,"\\|"):o,L=m?`![[${w}${d}]]`:`![[${s}${d}]]`;u.push({old_link:l,new_link:L,from_ch:a.index,to_ch:a.index+l.length})}}let r;for(;(r=c.exec(t))!==null;){let l=r[0];if(l.includes(h)){let p=l.match(/\[.*?\]/g);if(!p)continue;let m=p[0].substring(1,p[0].length-1),w=m.replace(/\|\d+(\|\d+)?$/g,"");n&&(w=m.replace(/\\\|\d+(\|\d+)?$/g,""));let _=l.substring(p[0].length+2,l.length-1),f=n?`![${w}\\|${e}](${_})`:`![${w}|${e}](${_})`;/^\d*$/.test(m)?u.push({old_link:l,new_link:`![${e}](${_})`,from_ch:r.index,to_ch:r.index+l.length}):u.push({old_link:l,new_link:f,from_ch:r.index,to_ch:r.index+l.length})}}return u}matchLineWithExternalLink(t,s,e,n,i){let c=[],h=/\!\[[^\[\]]*?\]\(\s*[^\[\]\{\}']*\s*\)/g;if(!t.includes(s))return[];let u;for(;(u=h.exec(t))!==null;){let a=u[0];if(a.includes(s)){let r=a.match(/\[.*?\]/g);if(!r)continue;let l=r[0].substring(1,r[0].length-1),p=l.replace(/\|\d+(\|\d+)?$/g,"");i&&(p=l.replace(/\\\|\d+(\|\d+)?$/g,"")),/^\d*$/.test(l)&&(p="");let m=a.substring(r[0].length+2,a.length-1),w=i?`![${p}\\|${n}](${m})`:`![${p}|${n}](${m})`;c.push({old_link:a,new_link:w,from_ch:u.index,to_ch:u.index+a.length})}}return c}getExcalidrawBaseName(t){let e=t.getAttribute("filesource")||"";if(e.includes("/")){let n=e.split("/");e=n[n.length-1]}else if(e.includes("\\")){let n=e.split("\\");e=n[n.length-1]}return e=e.endsWith(".md")?e.substring(0,e.length-3):e,e}};var z=class{constructor(t){this.isDragging=!1;this.dragTarget=null;this.startX=0;this.startY=0;this.startWidth=0;this.startHeight=0;this.lastUpdateX=0;this.lastUpdate=1;this.updatedWidth=0;this.lastMoveTime=0;this.plugin=t,this.linkUpdateService=new E(t)}registerDocument(t){let s=i=>{i.target.tagName==="IMG"&&this.handleMouseDown(i)};t.addEventListener("mousedown",s),this.plugin.register(()=>t.removeEventListener("mousedown",s));let e=i=>{i.target.tagName==="IMG"&&this.handleMouseMove(i)};t.addEventListener("mousemove",e),this.plugin.register(()=>t.removeEventListener("mousemove",e));let n=i=>{i.target.tagName==="IMG"&&this.handleMouseLeave(i)};t.addEventListener("mouseleave",n),this.plugin.register(()=>t.removeEventListener("mouseleave",n))}handleMouseDown(t){let s=this.plugin.app.workspace.getActiveFile();if(!s||s.name.endsWith(".canvas"))return;let e=this.plugin.app.workspace.getActiveViewOfType(R.MarkdownView);if(!e||e.getMode()==="preview")return;t.button===0&&t.preventDefault();let n=t.target,i=e.editor;if(!i)return;let c=n.getBoundingClientRect(),h=t.clientX-c.left,u=t.clientY-c.top,a=this.plugin.settings.edgeSize;h>c.width-a&&u>c.height-a&&this.startDrag(t,n,i)}handleMouseMove(t){let s=this.plugin.app.workspace.getActiveFile();if(!s||s.name.endsWith(".canvas"))return;let e=this.plugin.app.workspace.getActiveViewOfType(R.MarkdownView);if(!e||e.getMode()==="preview")return;let n=t.target,i=n.getBoundingClientRect(),c=t.clientX-i.left,h=t.clientY-i.top,u=this.plugin.settings.edgeSize;c>i.width-u&&h>i.height-u?n.style.cursor="nwse-resize":n.style.cursor=""}handleMouseLeave(t){let s=t.target;s.style.cursor=""}startDrag(t,s,e){this.isDragging=!0,this.dragTarget=s,this.startX=t.clientX,this.startY=t.clientY,this.startWidth=s.clientWidth,this.startHeight=s.clientHeight,this.lastUpdateX=this.startX,this.lastUpdate=1,this.updatedWidth=this.startWidth,this.lastMoveTime=Date.now();let i=e.cm.posAtDOM(s),c=r=>{r.preventDefault(),r.stopPropagation()},h=r=>{s.addEventListener("click",c),this.performDrag(r,s,i)},u=()=>{s.removeEventListener("click",c)},a=r=>{setTimeout(u,100),r.preventDefault(),document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",a),this.endDrag(s,i)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",a)}performDrag(t,s,e){let n=t.clientX;this.lastUpdate=n-this.lastUpdateX===0?this.lastUpdate:n-this.lastUpdateX;let i=this.startWidth+(n-this.startX),c=this.startWidth/this.startHeight;i=Math.max(i,50);let h=i/c;i=Math.round(i),h=Math.round(h),this.updatedWidth=i,s.style.width=`${i}px`;let u=Date.now();u-this.lastMoveTime<100||(this.lastMoveTime=u,this.linkUpdateService.updateImageLinkWithNewSize(s,e,i,h),this.lastUpdateX=t.clientX)}endDrag(t,s){if(t.style.removeProperty("width"),t.style.removeProperty("height"),t.style.removeProperty("max-width"),t.style.removeProperty("max-height"),this.plugin.settings.resizeInterval>1){let e=this.plugin.settings.resizeInterval,n=this.lastUpdate>0?e:0;this.updatedWidth%e!==0&&(this.updatedWidth=Math.floor(this.updatedWidth/e)*e+n),this.linkUpdateService.updateImageLinkWithNewSize(t,s,this.updatedWidth,0)}this.isDragging=!1,this.dragTarget=null}};var y=class extends T.Plugin{async onload(){console.log("Image Resize Plugin \u63D2\u4EF6\u5DF2\u52A0\u8F7D..."),await this.loadSettings(),this.resizeHandler=new z(this),this.addSettingTab(new b(this.app,this)),this.registerDocument(document),this.app.workspace.on("window-open",(s,e)=>{this.registerDocument(e.document)}),this.settings.debug&&(console.log("Image Resize Plugin \u8C03\u8BD5\u6A21\u5F0F\u5DF2\u542F\u7528"),console.log("\u5F53\u524D\u8BBE\u7F6E:",this.settings))}onunload(){console.log("Image Resize Plugin \u63D2\u4EF6\u5DF2\u5378\u8F7D...")}registerDocument(s){this.settings.dragResize&&this.resizeHandler.registerDocument(s)}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.settings.debug&&console.log("\u8BBE\u7F6E\u5DF2\u4FDD\u5B58:",this.settings)}};
